<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Booking Calendar</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:#fff;color:#111}

/* ===== TOP ===== */
.topbar{
  padding:8px 10px;
  border-bottom:1px solid #e5e5e5;
  display:flex;gap:12px;align-items:center;overflow-x:auto
}
.topbar input{padding:6px;font-size:14px}

/* ===== LEGEND ===== */
.legend{display:flex;gap:8px;font-size:12px;white-space:nowrap}
.legend-item{
  display:flex;align-items:center;gap:4px;
  padding:4px 6px;border-radius:6px;cursor:pointer
}
.legend-item.active{background:#eee}
.legend-color{width:12px;height:12px;border-radius:3px}

/* ===== GRID ===== */
.scroll-x{overflow-x:auto}
.header,.row{display:grid}

/* ===== Y AXIS ===== */
.room{
  width:92px;padding:6px;font-size:12px;
  background:#fafafa;border-right:1px solid #e5e5e5;
  position:sticky;left:0;z-index:3
}
.header .room{background:#f5f5f5;z-index:4}

/* ===== CORNER ===== */
.corner{
  position:relative;background:#f5f5f5;
  color:#777;font-size:10px
}
.corner::before{
  content:"";position:absolute;inset:0;
  background:linear-gradient(45deg,transparent 49.5%,#d0d0d0 50%,transparent 50.5%)
}
.corner-date{position:absolute;top:4px;left:6px}
.corner-room{position:absolute;bottom:4px;right:6px}

/* ===== CELL ===== */
.cell{
  position:relative;height:36px;border:1px solid #eee;
  display:flex;align-items:center;justify-content:center;
  font-size:12px;cursor:pointer
}

/* 第一次点：淡红色 */
.cell.selecting::after{
  content:"";position:absolute;inset:0;
  background:rgba(255,56,92,0.25)
}

/* ===== MERGED BAR ===== */
.bar{
  height:36px;color:#fff;font-size:11px;
  display:flex;align-items:center;justify-content:center;
  border-radius:4px;cursor:pointer
}

/* ===== COLORS ===== */
.src-airbnb{background:#ff385c}
.src-booking{background:#003580}
.src-agoda{background:#e60023}
.src-trip{background:#ff6f00}
.src-slh{background:#6a5acd}
.src-walkinwayne{background:#2e8b57}
.src-walkinsoo{background:#8b4513}

/* ===== MODAL ===== */
.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.35);
  display:none;z-index:1000
}
.modal-box{
  background:#fff;border-radius:16px 16px 0 0;
  padding:12px;position:absolute;bottom:0;left:0;right:0
}
.modal-box label{font-size:12px;color:#555}

/* 手机友好：输入框更短 */
.modal-box input,
.modal-box select{
  width:100%;padding:8px;margin:4px 0;
  font-size:14px;border-radius:8px;border:1px solid #ddd
}
.modal-box button{
  width:100%;padding:10px;margin:6px 0;
  font-size:15px;border-radius:10px;border:1px solid #ddd
}
.actions{display:flex;gap:8px}
.actions button{flex:1}
</style>
</head>

<body>

<div class="topbar">
  <input type="month" id="monthPicker">
  <div class="legend" id="legend"></div>
</div>

<div class="scroll-x">
  <div class="calendar" id="app"></div>
</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-box">
    <h3 id="modalTitle"></h3>

    <label>Room</label>
    <select id="roomInput"></select>

    <label>Check-in</label>
    <input type="date" id="checkinInput">

    <label>Check-out</label>
    <input type="date" id="checkoutInput">

    <label>Source</label>
    <select id="sourceInput"></select>

    <label>Price</label>
    <input type="number" id="priceInput" step="0.01">

    <label>Remark</label>
    <input type="text" id="remarkInput">

    <div class="actions">
      <button id="saveBtn"></button>
      <button id="deleteBtn" style="display:none">Delete</button>
      <button onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
const sb = supabase.createClient(
  'https://pwscsukxfnbzjciuhtwl.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3c2NzdWt4Zm5iempjaXVodHdsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MzU1MDQsImV4cCI6MjA4MjExMTUwNH0.YQEXs1S3wprPMOarCL_DLXDtsSgY6I7TFM4bp_gLkW8'
);

const SOURCES=['Airbnb','Booking','Agoda','Trip','SLH','Walk-in (Wayne)','Walk-in (Soo)'];

let ROOMS=[],BOOKINGS=[],DAYS=[];
let FILTER=new Set();
let selectState=null;
let editingBooking=null;

const app=document.getElementById('app');
const modal=document.getElementById('modal');
const saveBtn=document.getElementById('saveBtn');
const deleteBtn=document.getElementById('deleteBtn');
const modalTitle=document.getElementById('modalTitle');

const roomInput=document.getElementById('roomInput');
const checkinInput=document.getElementById('checkinInput');
const checkoutInput=document.getElementById('checkoutInput');
const sourceInput=document.getElementById('sourceInput');
const priceInput=document.getElementById('priceInput');
const remarkInput=document.getElementById('remarkInput');

monthPicker.value=new Date().toISOString().slice(0,7);
monthPicker.onchange=loadAll;
loadAll();

async function loadAll(){
  ROOMS=(await sb.from('rooms').select('*').order('id')).data||[];
  BOOKINGS=(await sb.from('booking_view').select('*')).data||[];
  buildDays();buildLegend();buildSelects();render();
}

function buildLegend(){
  legend.innerHTML='';
  const all=document.createElement('div');
  all.className='legend-item active';
  all.textContent='Show All';
  all.onclick=()=>{FILTER.clear();render()};
  legend.appendChild(all);

  SOURCES.forEach(s=>{
    const el=document.createElement('div');
    el.className='legend-item';
    el.innerHTML=`<span class="legend-color src-${norm(s)}"></span>${s}`;
    el.onclick=()=>{FILTER.has(s)?FILTER.delete(s):FILTER.add(s);el.classList.toggle('active');render()};
    legend.appendChild(el);
  });
}

function buildSelects(){
  roomInput.innerHTML='';
  ROOMS.forEach(r=>roomInput.innerHTML+=`<option value="${r.id}">${r.name}</option>`);
  sourceInput.innerHTML='';
  SOURCES.forEach(s=>sourceInput.innerHTML+=`<option>${s}</option>`);
}

function buildDays(){
  const [y,m]=monthPicker.value.split('-').map(Number);
  DAYS=[...Array(new Date(y,m,0).getDate())]
    .map((_,i)=>`${y}-${String(m).padStart(2,'0')}-${String(i+1).padStart(2,'0')}`);
}

function render(){
  let html='';
  const cols=`92px repeat(${DAYS.length},56px)`;

  html+=`<div class="header" style="grid-template-columns:${cols}">
    <div class="room corner">
      <span class="corner-date">Date</span>
      <span class="corner-room">Room</span>
    </div>`;
  DAYS.forEach(d=>html+=`<div class="cell">${d.slice(8)}</div>`);
  html+=`</div>`;

  ROOMS.forEach(r=>{
    html+=`<div class="row" style="grid-template-columns:${cols}">
      <div class="room">${r.name}</div>`;

    let i=0;
    while(i<DAYS.length){
      const d=DAYS[i];
      const b=BOOKINGS.find(x=>x.room===r.name && d>=x.check_in && d<x.check_out && (FILTER.size===0||FILTER.has(x.source)));

      if(!b){
        html+=`<div class="cell" data-room="${r.name}" data-date="${d}"
               onclick="onCellClick(this)"></div>`;
        i++;continue;
      }

      const span=(new Date(b.check_out)-new Date(d))/86400000;
      html+=`<div class="bar src-${norm(b.source)}"
                 style="grid-column:span ${span}"
                 onclick="openEdit(${b.id})">${b.price||''}</div>`;
      i+=span;
    }
    html+=`</div>`;
  });

  app.innerHTML=html;
}

function onCellClick(el){
  const room=el.dataset.room;
  const date=el.dataset.date;

  document.querySelectorAll('.cell.selecting').forEach(c=>c.classList.remove('selecting'));

  if(!selectState || selectState.room!==room){
    selectState={room,date};
    el.classList.add('selecting');
    return;
  }

  openNew(room,date);
  selectState=null;
}

function openNew(room,ci){
  modalTitle.textContent='New Booking';
  saveBtn.textContent='Save';
  editingBooking=null;

  roomInput.value=ROOMS.find(r=>r.name===room).id;
  checkinInput.value=ci;

  roomInput.disabled=true;
  checkinInput.disabled=true;
  sourceInput.disabled=true;

  deleteBtn.style.display='none';
  modal.style.display='block';
}

function openEdit(id){
  const b=BOOKINGS.find(x=>x.id===id);
  editingBooking=b;

  modalTitle.textContent='Edit Booking';
  saveBtn.textContent='Update';

  roomInput.value=b.room_id;
  checkinInput.value=b.check_in;
  checkoutInput.value=b.check_out;
  sourceInput.value=b.source;
  priceInput.value=b.price||'';
  remarkInput.value=b.remark||'';

  roomInput.disabled=false;
  checkinInput.disabled=false;
  sourceInput.disabled=false;

  deleteBtn.style.display='block';
  modal.style.display='block';
}

function closeModal(){modal.style.display='none'}

saveBtn.onclick=async()=>{
  const payload={
    room_id:+roomInput.value,
    check_in:checkinInput.value,
    check_out:checkoutInput.value,
    source:sourceInput.value,
    price:priceInput.value||0,
    remark:remarkInput.value||null
  };
  editingBooking
    ? await sb.from('bookings').update(payload).eq('id',editingBooking.id)
    : await sb.from('bookings').insert(payload);
  closeModal();loadAll();
};

deleteBtn.onclick=async()=>{
  await sb.from('bookings').delete().eq('id',editingBooking.id);
  closeModal();loadAll();
};

function norm(s){return s.toLowerCase().replace(/[^a-z]/g,'')}
</script>

</body>
</html>
