<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Booking Calendar</title>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
}

.topbar {
  padding: 8px;
  background: #fff;
  position: sticky;
  top: 0;
  z-index: 10;
  border-bottom: 1px solid #ddd;
}

.wrapper {
  overflow-x: auto;
}

.header, .row {
  display: grid;
  grid-auto-flow: column;
}

.room-col {
  width: 100px;
  min-width: 100px;
  background: #f5f5f5;
  border-right: 1px solid #ccc;
  font-weight: bold;
  text-align: center;
  line-height: 44px;
  position: sticky;
  left: 0;
  z-index: 2;
}

.cell {
  width: 72px;
  height: 44px;
  border: 1px solid #eee;
  text-align: center;
  line-height: 44px;
  font-size: 12px;
  touch-action: manipulation;
}

.header .cell {
  font-weight: bold;
  background: #fff;
  position: sticky;
  top: 40px;
  z-index: 3;
}

.free { background: #e8fbe8; }
.booked { background: #f8b4b4; }
</style>
</head>

<body>

<div class="topbar">
  <input id="monthPicker" type="month">
</div>

<div class="wrapper" id="app"></div>

<script>
/* ===== CONFIG ===== */
const API_URL = 'https://script.google.com/macros/s/AKfycbx0LAjaP3gb052UrXKOiqxbcquTX84F43JW4hLFOii9YSNefko0ENdRl6baTn7LW-VeBA/exec';

/* ===== STATE ===== */
let ROOMS = [];
let CURRENT_BOOKINGS = [];
let BOOKED_MAP = {};
let DAYS = [];
let CURRENT_MONTH = '';

/* ===== INIT ===== */
const monthPicker = document.getElementById('monthPicker');
CURRENT_MONTH = new Date().toISOString().slice(0,7);
monthPicker.value = CURRENT_MONTH;

/* ===== FETCH DATA ===== */
fetch(API_URL, { cache: 'no-store' })
  .then(r => r.json())
  .then(data => {
    ROOMS = data.rooms;
    CURRENT_BOOKINGS = data.bookings;
    BOOKED_MAP = buildBookedMap(data.bookings);
    DAYS = buildMonthDays(CURRENT_MONTH);
    renderGrid();
  });

/* ===== MONTH CHANGE ===== */
monthPicker.addEventListener('change', e => {
  CURRENT_MONTH = e.target.value;
  DAYS = buildMonthDays(CURRENT_MONTH);
  updateMonthView();
});

/* ===== DATE HELPERS ===== */
function buildMonthDays(month) {
  const [y, m] = month.split('-').map(Number);
  const d = new Date(y, m - 1, 1);
  const out = [];

  while (d.getMonth() === m - 1) {
    out.push(d.toISOString().slice(0,10));
    d.setDate(d.getDate() + 1);
  }
  return out;
}

/* ===== BOOKED MAP ===== */
function buildBookedMap(bookings) {
  const map = {};
  bookings.forEach(b => {
    let d = new Date(b.checkIn);
    const end = new Date(b.checkOut);

    while (d < end) {
      const day = d.toISOString().slice(0,10);
      map[`${b.room}|${day}`] = true;
      d.setDate(d.getDate() + 1);
    }
  });
  return map;
}

/* ===== RENDER GRID (ONCE) ===== */
function renderGrid() {
  const app = document.getElementById('app');
  app.innerHTML = '';

  const header = document.createElement('div');
  header.className = 'header';
  header.appendChild(document.createElement('div')).className = 'room-col';
  app.appendChild(header);

  ROOMS.forEach(room => {
    const row = document.createElement('div');
    row.className = 'row';

    const label = document.createElement('div');
    label.className = 'room-col';
    label.textContent = room;
    row.appendChild(label);

    DAYS.forEach(day => {
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.dataset.room = room;
      cell.dataset.date = day;
      row.appendChild(cell);
    });

    app.appendChild(row);
  });

  updateMonthView();
}

/* ===== UPDATE HEADER + CELLS (FAST) ===== */
function updateMonthView() {
  updateHeader();
  updateCells();
}

function updateHeader() {
  const header = document.querySelector('.header');
  header.innerHTML = '';
  header.appendChild(document.createElement('div')).className = 'room-col';

  DAYS.forEach(d => {
    const c = document.createElement('div');
    c.className = 'cell';
    c.textContent = d.slice(8); // DD
    header.appendChild(c);
  });
}

function updateCells() {
  document.querySelectorAll('.row').forEach(row => {
    const room = row.querySelector('.room-col').textContent;
    const cells = row.querySelectorAll('.cell');

    cells.forEach((cell, idx) => {
      if (idx === 0) return;

      const day = DAYS[idx - 1];
      cell.dataset.date = day;

      const key = `${room}|${day}`;
      if (BOOKED_MAP[key]) {
        cell.classList.remove('free');
        cell.classList.add('booked');
      } else {
        cell.classList.remove('booked');
        cell.classList.add('free');
      }
    });
  });
}

document.getElementById('app').addEventListener('click', e => {
  const cell = e.target;

  if (!cell.classList.contains('cell')) return;
  if (!cell.dataset.room || !cell.dataset.date) return;

  const room = cell.dataset.room;
  const day = cell.dataset.date;
  const isBooked = cell.classList.contains('booked');

  handleCellClick(room, day, isBooked);
});

let SELECTED_ROOM = null;
let SELECTED_START = null;

function handleCellClick(room, day, isBooked) {
  clearSelection();

  // 点红色：查看 booking（如果你还没做 C，可先 alert）
  if (isBooked) {
    alert(`${room}\n${day} is booked`);
    return;
  }

  // 第一次点
  if (!SELECTED_START || SELECTED_ROOM !== room) {
    SELECTED_ROOM = room;
    SELECTED_START = day;
    highlight(room, day, day);
    return;
  }

  // 第二次点（同房，day > start）
  if (day > SELECTED_START) {
    // 你后面可以换成 openModal
    alert(
      `New booking\nRoom: ${room}\n${SELECTED_START} → ${day}`
    );
    SELECTED_ROOM = null;
    SELECTED_START = null;
  } else {
    // 点到更早日期，重来
    SELECTED_START = day;
    highlight(room, day, day);
  }
}

function highlight(room, start, end) {
  document.querySelectorAll('.cell').forEach(c => {
    c.classList.remove('selected');
  });

  document.querySelectorAll(
    `.cell[data-room="${room}"]`
  ).forEach(c => {
    if (c.dataset.date >= start && c.dataset.date <= end) {
      c.classList.add('selected');
    }
  });
}

function clearSelection() {
  document.querySelectorAll('.cell').forEach(c => {
    c.classList.remove('selected');
  });
}

</script>

</body>
</html>
