<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Booking Calendar</title>

<style>
/* =========================
   STOP-BLEED STABLE CSS
   ========================= */

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont,
    "SF Pro Text","Helvetica Neue",Arial,sans-serif;
  background: #ffffff;
}

/* Top bar */
.topbar {
  padding: 8px 10px;
  border-bottom: 1px solid #ddd;
}

/* ONE wrapper only */
.wrapper {
  overflow-x: auto;
}

/* Grid core */
.header,
.row {
  display: grid;
  grid-auto-flow: column;
  grid-auto-columns: min-content;
}

/* Room column */
.room-col {
  width: 90px;
  min-width: 90px;
  height: 32px;
  line-height: 32px;
  border-right: 1px solid #ddd;
  background: #fafafa;
  text-align: center;
  font-size: 13px;
}

/* Date cell */
.cell {
  width: 56px;
  height: 32px;
  border: 1px solid #ddd;
  box-sizing: border-box;
  text-align: center;
  font-size: 12px;
  user-select: none;
  cursor: pointer;
}

/* States */
.free {
  background: #FFF8EB;
}

.booked {
  background: #F24E7C;
  color: #fff;
}

.selected {
  outline: 2px solid #34C759;
  outline-offset: -2px;
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.3);
}

.modal-box {
  background: #fff;
  width: 90%;
  max-width: 320px;
  margin: 20% auto;
  padding: 14px;
  border-radius: 10px;
}

.modal-box h3 {
  margin: 0 0 10px;
}

.modal-box input,
.modal-box select,
.modal-box button {
  width: 100%;
  margin-bottom: 8px;
  height: 32px;
}

/* ===== STEP 1: Sticky Room Column ===== */
.room-col {
  position: sticky;
  left: 0;
  z-index: 5;
  background: #fafafa;
}

/* ===== FIXED HEADER (SAFE, NO STICKY) ===== */
#fixedHeader {
  position: fixed;
  top: 48px;              /* 在 topbar 下方 */
  left: 0;
  right: 0;
  background: #ffffff;
  z-index: 10;
  overflow: hidden;
  pointer-events: none;   /* 不挡点击 */
  display: none;
}

/* fixed header 内部的 grid */
#fixedHeader .header {
  display: grid;
  grid-auto-flow: column;
  grid-auto-columns: min-content;
}

/* fixed header 的 cell */
#fixedHeader .cell {
  width: 56px;
  height: 32px;
  line-height: 32px;
  border: 1px solid #ddd;
  box-sizing: border-box;
  text-align: center;
  font-size: 12px;
  background: #ffffff;
}

/* 左上角占位 */
#fixedHeader .room-col {
  width: 90px;
  min-width: 90px;
  background: #fafafa;
}

</style>
</head>

<body>

<div class="topbar">
  <input type="month" id="monthPicker">
</div>

<div id="fixedHeader"></div>

<div class="wrapper" id="app"></div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="modal-box">
    <h3 id="modalTitle">New Booking</h3>

    <label>Room</label>
    <select id="roomInput"></select>

    <label>Check-in</label>
    <input id="checkInInput" readonly>

    <label>Check-out</label>
    <input id="checkOutInput" readonly>

    <button id="saveBtn">Save</button>
    <button id="deleteBtn">Delete</button>
    <button onclick="closeModal()">Close</button>
  </div>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbxdl0gBcDgUcH8wtw1DUEb9RLHh3RHgXs9u3Gp6r-7V-pnrtFZXht7V9GydnQO8I0ja/exec';

const app = document.getElementById('app');
const monthPicker = document.getElementById('monthPicker');

/* ===== STATE ===== */
let ROOMS = [];
let BOOKINGS = [];
let BOOKED_MAP = {};
let DAYS = [];

let SELECT_ROOM = null;
let SELECT_START = null;
let EDIT_BOOKING = null;

/* ===== INIT ===== */
monthPicker.value = new Date().toISOString().slice(0,7);
monthPicker.addEventListener('change', load);

load();

/* ===== LOAD DATA ===== */
function load() {
  clearSelection();          // ✅ 防止残留选择
  app.innerHTML = '';        // ✅ 确保只有一个 grid

  fetch(API_URL)
    .then(r => r.json())
    .then(data => {
      ROOMS = data.rooms;
      BOOKINGS = data.bookings;
      BOOKED_MAP = buildBookedMap(BOOKINGS);
      DAYS = buildDays(monthPicker.value);
      render();              // ✅ render 只在这里
    });
}

/* ===== UTIL ===== */
function buildDays(month) {
  const [y,m] = month.split('-').map(Number);
  const total = new Date(y, m, 0).getDate();
  return Array.from({length: total}, (_,i) =>
    `${y}-${String(m).padStart(2,'0')}-${String(i+1).padStart(2,'0')}`
  );
}

function buildBookedMap(bookings) {
  const map = {};
  bookings.forEach(b => {
    let d = new Date(b.checkIn);
    const end = new Date(b.checkOut);
    while (d < end) {
      map[`${b.room}|${d.toISOString().slice(0,10)}`] = b;
      d.setDate(d.getDate()+1);
    }
  });
  return map;
}

/* ===== RENDER (只一次) ===== */
function render() {
  // Header
  const header = document.createElement('div');
  header.className = 'header';

  const corner = document.createElement('div');
  corner.className = 'room-col';
  header.appendChild(corner);

  DAYS.forEach(d => {
    const c = document.createElement('div');
    c.className = 'cell';
    c.textContent = d.slice(8);
    header.appendChild(c);
  });

  app.appendChild(header);

  // Rows
  ROOMS.forEach(room => {
    const row = document.createElement('div');
    row.className = 'row';

    const label = document.createElement('div');
    label.className = 'room-col';
    label.textContent = room;
    row.appendChild(label);

    DAYS.forEach(day => {
      const c = document.createElement('div');
      c.className = 'cell ' +
        (BOOKED_MAP[`${room}|${day}`] ? 'booked' : 'free');

      c.addEventListener('click', () => onCellClick(room, day));
      row.appendChild(c);
    });

    app.appendChild(row);
  });
}

/* ===== CLICK ===== */
function onCellClick(room, day) {
  const booking = BOOKED_MAP[`${room}|${day}`];

  if (booking) {
    openEdit(booking);
    return;
  }

  if (!SELECT_START || SELECT_ROOM !== room) {
    clearSelection();
    SELECT_ROOM = room;
    SELECT_START = day;
    highlight(room, day, day);
    return;
  }

  if (day > SELECT_START) {
    openNew(room, SELECT_START, day);
    clearSelection();
  } else {
    SELECT_START = day;
    highlight(room, day, day);
  }
}

/* ===== SELECTION ===== */
function highlight(room, start, end) {
  document.querySelectorAll('.cell').forEach(c =>
    c.classList.remove('selected')
  );

  document.querySelectorAll('.row').forEach(r => {
    if (r.firstChild.textContent !== room) return;
    const cells = r.querySelectorAll('.cell');
    cells.forEach((c,i)=>{
      const d = DAYS[i];
      if (d >= start && d <= end) c.classList.add('selected');
    });
  });
}

function clearSelection() {
  SELECT_ROOM = null;
  SELECT_START = null;
  document.querySelectorAll('.cell').forEach(c =>
    c.classList.remove('selected')
  );
}

/* ===== MODAL ===== */
const modal = document.getElementById('modal');
const roomInput = document.getElementById('roomInput');
const checkInInput = document.getElementById('checkInInput');
const checkOutInput = document.getElementById('checkOutInput');
const saveBtn = document.getElementById('saveBtn');
const deleteBtn = document.getElementById('deleteBtn');
const modalTitle = document.getElementById('modalTitle');

function openNew(room, ci, co) {
  EDIT_BOOKING = null;
  modalTitle.textContent = 'New Booking';
  deleteBtn.style.display = 'none';
  fillRooms(room);
  checkInInput.value = ci;
  checkOutInput.value = co;
  modal.style.display = 'block';
}

function openEdit(b) {
  EDIT_BOOKING = b;
  modalTitle.textContent = 'Edit Booking';
  deleteBtn.style.display = 'block';
  fillRooms(b.room);
  checkInInput.value = b.checkIn;
  checkOutInput.value = b.checkOut;
  modal.style.display = 'block';
}

function fillRooms(selected) {
  roomInput.innerHTML = '';
  ROOMS.forEach(r => {
    const o = document.createElement('option');
    o.value = r;
    o.textContent = r;
    if (r === selected) o.selected = true;
    roomInput.appendChild(o);
  });
}

function closeModal() {
  modal.style.display = 'none';
  EDIT_BOOKING = null;
}

/* ===== SAVE / DELETE ===== */
saveBtn.onclick = () => {
  const payload = EDIT_BOOKING ? {
    action: 'update',
    old: EDIT_BOOKING,
    room: roomInput.value,
    checkIn: checkInInput.value,
    checkOut: checkOutInput.value
  } : {
    action: 'create',
    room: roomInput.value,
    checkIn: checkInInput.value,
    checkOut: checkOutInput.value
  };

  fetch(API_URL, {
    method:'POST',
    body: JSON.stringify(payload)
  }).then(load);
};

deleteBtn.onclick = () => {
  fetch(API_URL, {
    method:'POST',
    body: JSON.stringify({
      action:'delete',
      booking: EDIT_BOOKING
    })
  }).then(load);
};
</script>

</body>
</html>
