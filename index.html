<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Booking Calendar</title>

<style>
:root {
  --row-h: 34px;
  --cell-w: 56px;
  --border: #e5e5ea;
  --free: #eef9f1;
  --booked: #fbe4e6;
  --accent: #34c759;
  --text: #1c1c1e;
}

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text",
               "Helvetica Neue", Arial, sans-serif;
  color: var(--text);
}

.topbar {
  padding: 6px 10px;
  background: #fff;
  position: sticky;
  top: 0;
  z-index: 10;
  border-bottom: 1px solid var(--border);
}

.wrapper {
  overflow-x: auto;
}

.header, .row {
  display: grid;
  grid-auto-flow: column;
}

.room-col {
  width: 90px;
  min-width: 90px;
  background: #fafafa;
  border-right: 1px solid var(--border);
  font-size: 13px;
  line-height: var(--row-h);
  text-align: center;
  position: sticky;
  left: 0;
  z-index: 2;
}

.cell {
  width: var(--cell-w);
  height: var(--row-h);
  border: 1px solid var(--border);
  font-size: 12px;
  line-height: var(--row-h);
  text-align: center;
  touch-action: manipulation;
}

.header .cell {
  font-weight: 500;
  background: #fff;
  position: sticky;
  top: 38px;
  z-index: 3;
}

.free { background: var(--free); }
.booked { background: var(--booked); }

.selected {
  outline: 2px solid var(--accent);
  z-index: 4;
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.35);
  z-index: 99;
}
.modal-box {
  background: #fff;
  margin: 22% auto;
  padding: 14px;
  width: 90%;
  max-width: 320px;
  border-radius: 14px;
}
.modal-box h3 {
  margin: 0 0 10px;
  font-size: 16px;
}
.modal-box label {
  font-size: 12px;
  color: #666;
}
.modal-box input,
.modal-box select {
  width: 100%;
  margin-bottom: 8px;
  height: 32px;
}
.modal-box button {
  width: 100%;
  height: 36px;
  margin-top: 6px;
  border-radius: 10px;
  border: none;
  font-size: 14px;
}
.primary { background: var(--accent); color: #fff; }
.danger { background: #ff3b30; color: #fff; }
.secondary { background: #e5e5ea; }
</style>
</head>

<body>

<div class="topbar">
  <input id="monthPicker" type="month">
</div>

<div class="wrapper" id="app"></div>

<!-- MODAL -->
<div id="bookingModal" class="modal">
  <div class="modal-box">
    <h3 id="modalTitle">Booking</h3>

    <label>Room</label>
    <select id="roomSelect"></select>

    <label>Check-in</label>
    <input id="checkInInput" readonly>

    <label>Check-out</label>
    <input id="checkOutInput" readonly>

    <button id="actionBtn" class="primary">Save</button>
    <button id="deleteBtn" class="danger">Delete</button>
    <button class="secondary" onclick="closeModal()">Close</button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

const API_URL = 'https://script.google.com/macros/s/AKfycbxdl0gBcDgUcH8wtw1DUEb9RLHh3RHgXs9u3Gp6r-7V-pnrtFZXht7V9GydnQO8I0ja/exec';

/* ===== STATE ===== */
let ROOMS = [];
let BOOKINGS = [];
let BOOKED_MAP = {};
let DAYS = [];
let CURRENT_MONTH = '';
let SELECTED_ROOM = null;
let SELECTED_START = null;
let CURRENT_EDIT = null;

/* ===== ELEMENTS ===== */
const app = document.getElementById('app');
const monthPicker = document.getElementById('monthPicker');

/* ===== INIT ===== */
CURRENT_MONTH = new Date().toISOString().slice(0,7);
monthPicker.value = CURRENT_MONTH;

loadData(true);

/* ===== LEVEL 2: AUTO REFRESH ===== */
setInterval(() => silentRefresh(), 5000);

/* ===== EVENTS ===== */
monthPicker.addEventListener('change', e => {
  CURRENT_MONTH = e.target.value;
  DAYS = buildMonthDays(CURRENT_MONTH);
  updateMonthView();
  clearSelection();
});

/* ===== DATA ===== */
function loadData(initial=false) {
  fetch(API_URL, { cache:'no-store' })
    .then(r => r.json())
    .then(data => {
      ROOMS = data.rooms;
      BOOKINGS = data.bookings;
      BOOKED_MAP = buildBookedMap(BOOKINGS);
      DAYS = buildMonthDays(CURRENT_MONTH);
      if (initial) renderGrid();
      else updateCells();
    });
}

function silentRefresh() {
  fetch(API_URL, { cache:'no-store' })
    .then(r => r.json())
    .then(data => {
      const newMap = buildBookedMap(data.bookings);
      if (!sameMap(newMap, BOOKED_MAP)) {
        BOOKINGS = data.bookings;
        BOOKED_MAP = newMap;
        updateCells();
      }
    });
}

function sameMap(a,b) {
  const ka = Object.keys(a);
  const kb = Object.keys(b);
  if (ka.length !== kb.length) return false;
  return ka.every(k => b[k]);
}

function buildMonthDays(month) {
  const [y,m] = month.split('-').map(Number);
  const total = new Date(y,m,0).getDate();
  return Array.from({length:total},(_,i)=>
    `${y}-${String(m).padStart(2,'0')}-${String(i+1).padStart(2,'0')}`
  );
}

function buildBookedMap(bookings) {
  const map = {};
  bookings.forEach(b => {
    let d = new Date(b.checkIn);
    const end = new Date(b.checkOut);
    while (d < end) {
      map[`${b.room}|${d.toISOString().slice(0,10)}`] = b;
      d.setDate(d.getDate()+1);
    }
  });
  return map;
}

/* ===== RENDER ===== */
function renderGrid() {
  app.innerHTML = '';
  const header = document.createElement('div');
  header.className = 'header';
  header.appendChild(document.createElement('div')).className = 'room-col';
  app.appendChild(header);

  ROOMS.forEach(room => {
    const row = document.createElement('div');
    row.className = 'row';

    const label = document.createElement('div');
    label.className = 'room-col';
    label.textContent = room;
    row.appendChild(label);

    DAYS.forEach(day => {
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.dataset.room = room;
      cell.dataset.date = day;
      row.appendChild(cell);
    });
    app.appendChild(row);
  });

  updateMonthView();
}

function updateMonthView() {
  updateHeader();
  updateCells();
}

function updateHeader() {
  const header = document.querySelector('.header');
  header.innerHTML = '';
  header.appendChild(document.createElement('div')).className = 'room-col';
  DAYS.forEach(d => {
    const c = document.createElement('div');
    c.className = 'cell';
    c.textContent = d.slice(8);
    header.appendChild(c);
  });
}

function updateCells() {
  document.querySelectorAll('.row').forEach(row => {
    const room = row.querySelector('.room-col').textContent;
    const cells = row.querySelectorAll('.cell');
    cells.forEach((cell,idx)=>{
      if(idx===0) return;
      const day = DAYS[idx-1];
      cell.dataset.date = day;
      cell.className = 'cell ' +
        (BOOKED_MAP[`${room}|${day}`] ? 'booked':'free');
    });
  });
}

/* ===== CLICK ===== */
app.addEventListener('click', e => {
  const cell = e.target;
  if (!cell.classList.contains('cell')) return;
  if (!cell.dataset.room || !cell.dataset.date) return;

  const room = cell.dataset.room;
  const day = cell.dataset.date;
  const booking = BOOKED_MAP[`${room}|${day}`];

  if (booking) openEditModal(booking);
  else handleNewClick(room, day);
});

/* ===== NEW ===== */
function handleNewClick(room, day) {
  clearSelection();
  if (!SELECTED_START || SELECTED_ROOM !== room) {
    SELECTED_ROOM = room;
    SELECTED_START = day;
    highlight(room,day,day);
    return;
  }
  if (day > SELECTED_START) {
    openNewModal(room, SELECTED_START, day);
    SELECTED_ROOM = SELECTED_START = null;
    clearSelection();
  } else {
    SELECTED_START = day;
    highlight(room,day,day);
  }
}

/* ===== MODAL ===== */
function populateRooms(selected) {
  roomSelect.innerHTML = '';
  ROOMS.forEach(r=>{
    const o=document.createElement('option');
    o.value=r; o.textContent=r;
    if(r===selected) o.selected=true;
    roomSelect.appendChild(o);
  });
}

function openNewModal(room, ci, co) {
  CURRENT_EDIT = null;
  modalTitle.textContent = 'New Booking';
  actionBtn.textContent = 'Save';
  deleteBtn.style.display = 'none';
  populateRooms(room);
  checkInInput.value = ci;
  checkOutInput.value = co;
  bookingModal.style.display = 'block';
}

function openEditModal(b) {
  CURRENT_EDIT = b;
  modalTitle.textContent = 'Edit Booking';
  actionBtn.textContent = 'Update';
  deleteBtn.style.display = 'block';
  populateRooms(b.room);
  checkInInput.value = b.checkIn;
  checkOutInput.value = b.checkOut;
  bookingModal.style.display = 'block';
}

window.closeModal = ()=> bookingModal.style.display='none';

/* ===== SAVE / UPDATE / DELETE ===== */
actionBtn.onclick = () => {
  const payload = {
    action: CURRENT_EDIT ? 'update' : 'create',
    old: CURRENT_EDIT,
    room: roomSelect.value,
    checkIn: checkInInput.value,
    checkOut: checkOutInput.value
  };

  fetch(API_URL,{method:'POST',body:JSON.stringify(payload)})
    .then(r=>r.json())
    .then(res=>{
      if(res.status==='conflict'){
        alert('Room status updated. Please try again.');
        return;
      }
      loadData(); // 局部更新，不白屏
      closeModal();
    });
};

deleteBtn.onclick = () => {
  fetch(API_URL,{
    method:'POST',
    body:JSON.stringify({action:'delete', booking: CURRENT_EDIT})
  }).then(()=>{ loadData(); closeModal(); });
};

/* ===== UI HELPERS ===== */
function highlight(room,start,end){
  document.querySelectorAll('.cell').forEach(c=>c.classList.remove('selected'));
  document.querySelectorAll(`.cell[data-room="${room}"]`)
    .forEach(c=>{
      if(c.dataset.date>=start && c.dataset.date<=end)
        c.classList.add('selected');
    });
}
function clearSelection(){
  document.querySelectorAll('.cell').forEach(c=>c.classList.remove('selected'));
}

});
</script>

</body>
</html>
