<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Booking Calendar</title>

<style>
:root {
  --row-h: 32px;
  --cell-w: 56px;
  --room-w: 90px;

  --free: #FFF8EB;
  --booked: #F24E7C;
  --border: #ddd;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont,
    "SF Pro Text","Helvetica Neue",Arial,sans-serif;
  background: #fff;
}

/* Top bar */
.topbar {
  padding: 8px 10px;
  border-bottom: 1px solid var(--border);
}

/* Calendar wrapper */
.wrapper {
  overflow-x: auto;
}

/* Grid */
.header,
.row {
  display: grid;
  grid-auto-flow: column;
  grid-auto-columns: min-content;
}

/* Room column */
.room-col {
  width: var(--room-w);
  min-width: var(--room-w);
  height: var(--row-h);
  line-height: var(--row-h);
  text-align: center;
  background: #fafafa;
  border-right: 1px solid var(--border);
  font-size: 13px;
}

/* Date cell */
.cell {
  width: var(--cell-w);
  height: var(--row-h);
  border: 1px solid var(--border);
  text-align: center;
  font-size: 12px;
  user-select: none;
  cursor: pointer;
}

/* States */
.free { background: var(--free); }
.booked { background: var(--booked); color: #fff; }

.selected {
  outline: 2px solid #34C759;
  outline-offset: -2px;
}

/* Desktop: sticky room */
@media (min-width: 769px) {
  .room-col {
    position: sticky;
    left: 0;
    z-index: 5;
  }
}

/* Mobile UX fixes */
@media (max-width: 768px) {
  .room-col {
    position: relative;
    left: auto;
    z-index: 1;
  }
  .cell:hover,
  .cell:active {
    background: inherit;
  }
}

/* Prevent room highlight */
.room-col:hover,
.room-col:active,
.row:hover .room-col {
  background: #fafafa !important;
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.35);
  z-index: 9999;
}

.modal-box {
  background: #fff;
  width: 90%;
  max-width: 320px;
  margin: 20% auto;
  padding: 14px;
  border-radius: 12px;
}

.modal-box h3 {
  margin: 0 0 10px;
}

.modal-box input,
.modal-box select,
.modal-box button {
  width: 100%;
  height: 34px;
  margin-bottom: 8px;
}
</style>
</head>

<body>

<div class="topbar">
  <input type="month" id="monthPicker">
</div>

<div class="wrapper" id="app"></div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="modal-box">
    <h3 id="modalTitle">Booking</h3>

    <label>Room</label>
    <select id="roomInput"></select>

    <label>Check-in</label>
    <input id="checkInInput" readonly>

    <label>Check-out</label>
    <input id="checkOutInput" readonly>

    <button id="saveBtn">Save</button>
    <button id="deleteBtn">Delete</button>
    <button onclick="closeModal()">Close</button>
  </div>
</div>

<script>
  const SOURCES = [
  "Booking",
  "Trip",
  "Agoda",
  "Airbnb",
  "SLH",
  "Walk-in (Wayne)",
  "Walk-in (Soo)"
];

/* ================= CONFIG ================= */
const API_URL = 'https://script.google.com/macros/s/AKfycbxd5Ri0S06IsjqQ6BSNx0uGxzLJyTZGf-0asPxszpE2vvUZOT6wDwTAlZRQPupzTVTLZg/exec';

/* ================= STATE ================= */
let ROOMS = [];
let BOOKINGS = [];
let BOOKED_MAP = {};
let DAYS = [];

let SELECT_ROOM = null;
let SELECT_START = null;
let EDIT_BOOKING = null;

/* ================= INIT ================= */
const app = document.getElementById('app');
const monthPicker = document.getElementById('monthPicker');

monthPicker.value = new Date().toISOString().slice(0,7);
monthPicker.addEventListener('change', load);

load();

/* ================= LOAD ================= */
function load() {
  fetch(API_URL)
    .then(r => r.json())
    .then(data => {
      ROOMS = data.rooms;
      BOOKINGS = data.bookings;
      BOOKED_MAP = buildBookedMap(BOOKINGS);
      DAYS = buildDays(monthPicker.value);
      render();
    });
}

function buildDays(month) {
  const [y,m] = month.split('-').map(Number);
  const total = new Date(y, m, 0).getDate();
  return Array.from({length: total}, (_,i) =>
    `${y}-${String(m).padStart(2,'0')}-${String(i+1).padStart(2,'0')}`
  );
}

function buildBookedMap(bookings) {
  const map = {};
  bookings.forEach(b => {
    let d = new Date(b.checkIn);
    const end = new Date(b.checkOut);
    while (d < end) {
      map[`${b.room}|${d.toISOString().slice(0,10)}`] = b;
      d.setDate(d.getDate()+1);
    }
  });
  return map;
}

/* ================= RENDER ================= */
function render() {
  app.innerHTML = '';

  // Header
  const header = document.createElement('div');
  header.className = 'header';
  header.appendChild(document.createElement('div')).className = 'room-col';

  DAYS.forEach(d => {
    const c = document.createElement('div');
    c.className = 'cell';
    c.textContent = d.slice(8);
    header.appendChild(c);
  });
  app.appendChild(header);

  // Rows
  ROOMS.forEach(room => {
    const row = document.createElement('div');
    row.className = 'row';

    const label = document.createElement('div');
    label.className = 'room-col';
    label.textContent = room;
    row.appendChild(label);

    DAYS.forEach(day => {
      const c = document.createElement('div');
      c.className = 'cell ' + (BOOKED_MAP[`${room}|${day}`] ? 'booked' : 'free');
      c.addEventListener('click', () => onCellClick(room, day));
      row.appendChild(c);
    });

    app.appendChild(row);
  });
}

/* ================= INTERACTION ================= */
function onCellClick(room, day) {
  const booking = BOOKED_MAP[`${room}|${day}`];

  if (booking) {
    openEdit(booking);
    return;
  }

  if (!SELECT_START || SELECT_ROOM !== room) {
    clearSelection();
    SELECT_ROOM = room;
    SELECT_START = day;
    highlight(room, day, day);
    return;
  }

  if (day > SELECT_START) {
    openNew(room, SELECT_START, day);
    clearSelection();
  } else {
    SELECT_START = day;
    highlight(room, day, day);
  }
}

function highlight(room, start, end) {
  document.querySelectorAll('.cell').forEach(c => c.classList.remove('selected'));
  document.querySelectorAll('.row').forEach(r => {
    if (r.firstChild.textContent !== room) return;
    r.querySelectorAll('.cell').forEach((c,i) => {
      const d = DAYS[i];
      if (d >= start && d <= end) c.classList.add('selected');
    });
  });
}

function clearSelection() {
  SELECT_ROOM = null;
  SELECT_START = null;
  document.querySelectorAll('.cell').forEach(c => c.classList.remove('selected'));
}

/* ================= MODAL ================= */
const modal = document.getElementById('modal');
const roomInput = document.getElementById('roomInput');
const checkInInput = document.getElementById('checkInInput');
const checkOutInput = document.getElementById('checkOutInput');
const saveBtn = document.getElementById('saveBtn');
const deleteBtn = document.getElementById('deleteBtn');
const modalTitle = document.getElementById('modalTitle');

function openNew(room, ci, co) {
  EDIT_BOOKING = null;
  modalTitle.textContent = 'New Booking';
  deleteBtn.style.display = 'none';
  fillRooms(room);
  checkInInput.value = ci;
  checkOutInput.value = co;
  modal.style.display = 'block';
}

function openEdit(b) {
  EDIT_BOOKING = b;
  modalTitle.textContent = 'Edit Booking';
  deleteBtn.style.display = 'block';
  fillRooms(b.room);
  checkInInput.value = b.checkIn;
  checkOutInput.value = b.checkOut;
  modal.style.display = 'block';
}

function fillRooms(selected) {
  roomInput.innerHTML = '';
  ROOMS.forEach(r => {
    const o = document.createElement('option');
    o.value = r;
    o.textContent = r;
    if (r === selected) o.selected = true;
    roomInput.appendChild(o);
  });
}

function closeModal() {
  modal.style.display = 'none';
  EDIT_BOOKING = null;
}

/* ================= SAVE / DELETE (NO RELOAD) ================= */
saveBtn.onclick = () => {
  const payload = EDIT_BOOKING ? {
    action: 'update',
    old: EDIT_BOOKING,
    room: roomInput.value,
    checkIn: checkInInput.value,
    checkOut: checkOutInput.value
  } : {
    action: 'create',
    room: roomInput.value,
    checkIn: checkInInput.value,
    checkOut: checkOutInput.value
  };

  fetch(API_URL, { method:'POST', body: JSON.stringify(payload) })
    .then(() => {
      if (EDIT_BOOKING) {
        BOOKINGS = BOOKINGS.filter(b =>
          !(b.room === EDIT_BOOKING.room &&
            b.checkIn === EDIT_BOOKING.checkIn &&
            b.checkOut === EDIT_BOOKING.checkOut)
        );
      }

      BOOKINGS.push({
        room: roomInput.value,
        checkIn: checkInInput.value,
        checkOut: checkOutInput.value
      });

      BOOKED_MAP = buildBookedMap(BOOKINGS);
      closeModal();
      render();
    });
};

deleteBtn.onclick = () => {
  fetch(API_URL, {
    method:'POST',
    body: JSON.stringify({ action:'delete', booking: EDIT_BOOKING })
  }).then(() => {
    BOOKINGS = BOOKINGS.filter(b =>
      !(b.room === EDIT_BOOKING.room &&
        b.checkIn === EDIT_BOOKING.checkIn &&
        b.checkOut === EDIT_BOOKING.checkOut)
    );
    BOOKED_MAP = buildBookedMap(BOOKINGS);
    closeModal();
    render();
  });
};
</script>

</body>
</html>
