<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Booking Calendar</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Arial;
  margin: 0;
}
.topbar {
  padding: 8px;
  border-bottom: 1px solid #ddd;
}
.wrapper {
  overflow-x: auto;
}
.row, .header {
  display: grid;
  grid-auto-flow: column;
  grid-auto-columns: 60px;
}
.room {
  width: 100px;
  background: #fafafa;
  border-right: 1px solid #ddd;
  text-align: center;
  font-size: 13px;
}
.cell {
  height: 32px;
  border: 1px solid #ddd;
  text-align: center;
  font-size: 12px;
}
.free { background: #FFF8EB; }
.booked { color: #fff; }
.src-airbnb { background:#ff385c; }
.src-booking { background:#003580; }
.src-agoda { background:#e60023; }
.src-trip { background:#ff6f00; }
.src-slh { background:#6a5acd; }
</style>
</head>

<body>

<div class="topbar">
  <input type="month" id="monthPicker">
</div>

<div class="wrapper" id="app"></div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = 'https://pwscsukxfnbzjciuhtwl.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3c2NzdWt4Zm5iempjaXVodHdsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MzU1MDQsImV4cCI6MjA4MjExMTUwNH0.YQEXs1S3wprPMOarCL_DLXDtsSgY6I7TFM4bp_gLkW8';

const supabase = supabaseJs.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* ================= STATE ================= */
let ROOMS = [];
let BOOKINGS = [];
let DAYS = [];

/* ================= INIT ================= */
const app = document.getElementById('app');
const monthPicker = document.getElementById('monthPicker');
monthPicker.value = new Date().toISOString().slice(0,7);
monthPicker.onchange = loadAll;

/* ================= LOAD ================= */
async function loadAll() {
  await loadRooms();
  await loadBookings();
  buildDays();
  render();
}

async function loadRooms() {
  const { data } = await supabase.from('rooms').select('*').order('id');
  ROOMS = data || [];
}

async function loadBookings() {
  const { data } = await supabase
    .from('booking_view')
    .select('*');
  BOOKINGS = data || [];
}

function buildDays() {
  const [y,m] = monthPicker.value.split('-').map(Number);
  DAYS = Array.from(
    { length: new Date(y, m, 0).getDate() },
    (_,i)=>`${y}-${String(m).padStart(2,'0')}-${String(i+1).padStart(2,'0')}`
  );
}

/* ================= RENDER ================= */
function render() {
  app.innerHTML = '';

  // header
  const header = document.createElement('div');
  header.className = 'header';
  header.appendChild(document.createElement('div')).className = 'room';
  DAYS.forEach(d=>{
    const c = document.createElement('div');
    c.className='cell';
    c.textContent=d.slice(8);
    header.appendChild(c);
  });
  app.appendChild(header);

  // rows
  ROOMS.forEach(r=>{
    const row=document.createElement('div');
    row.className='row';

    const rc=document.createElement('div');
    rc.className='room';
    rc.textContent=r.name;
    row.appendChild(rc);

    DAYS.forEach(d=>{
      const cell=document.createElement('div');
      const b = BOOKINGS.find(x =>
        x.room===r.name &&
        d>=x.check_in &&
        d<x.check_out
      );

      if (b) {
        cell.className=`cell booked src-${b.source.toLowerCase().replace(/[^a-z]/g,'')}`;
      } else {
        cell.className='cell free';
      }
      row.appendChild(cell);
    });

    app.appendChild(row);
  });
}

/* ================= REALTIME ================= */
supabase
  .channel('bookings-realtime')
  .on(
    'postgres_changes',
    { event: '*', schema: 'public', table: 'bookings' },
    payload => {
      console.log('Realtime update', payload.eventType);
      loadBookings().then(render);
    }
  )
  .subscribe();

/* ================= START ================= */
loadAll();
</script>

</body>
</html>
