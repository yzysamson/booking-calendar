<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Booking Calendar</title>

<style>
:root {
  --row-h: 30px;
  --cell-w: 52px;
  --room-w: 84px;

  --border: #e5e5ea;

  --free: #FFF8EB;      /* ğŸ‘ˆ æ²¡è¢« book çš„æ ¼å­ */
  --booked: #F24E7C;    /* ğŸ‘ˆ å·² book çš„æ·±è‰² */

  --accent: #34C759;

  --text: #1c1c1e;
  --muted: #8e8e93;
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  background: #ffffff;   /* ğŸ‘ˆ é¡µé¢èƒŒæ™¯å›ç™½ */
  font-family: -apple-system, BlinkMacSystemFont,
    "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
  color: var(--text);
}

/* ===== TOP BAR ===== */
.topbar {
  padding: 6px 10px;
  background: #ffffff;
  position: sticky;
  top: 0;
  z-index: 20;
  border-bottom: 0.5px solid var(--border);
}

/* ===== SCROLL WRAPPER ===== */
.wrapper {
  overflow-x: auto;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

/* ===== GRID COREï¼ˆä¸èƒ½åŠ¨ï¼‰ ===== */
.header,
.row {
  display: grid;
  grid-auto-flow: column;
  grid-auto-columns: min-content;
}

/* ===== ROOM COLUMN ===== */
.room-col {
  width: var(--room-w);
  min-width: var(--room-w);
  height: var(--row-h);
  line-height: var(--row-h);

  background: #fafafa;
  border-right: 0.5px solid var(--border);

  font-size: 12px;
  font-weight: 500;
  text-align: center;

  position: sticky;
  left: 0;
  z-index: 30;
}

/* ===== HEADER ROW ===== */
.header {
  position: sticky;
  z-index: 10;
  background: #ffffff;
}

.header .cell {
  font-size: 11px;
  font-weight: 500;
  color: var(--muted);
  background: #ffffff;
}

/* ===== CELL ===== */
.cell {
  width: var(--cell-w);
  height: var(--row-h);
  line-height: var(--row-h);

  border: 0.5px solid var(--border);
  font-size: 11px;
  text-align: center;

  user-select: none;
  touch-action: manipulation;

  position: relative;
  z-index: 1;
}

/* ===== FREE (æœªè¢« booking) ===== */
.free {
  background: var(--free);
}

/* ===== BOOKED (åŸºç¡€) ===== */
.booked {
  background: var(--booked);
  color: #ffffff;
  border-color: var(--booked);
  border-radius: 0;
}

/* ===== AIRBNB-STYLE PILL ===== */
.booked.start {
  border-top-left-radius: 999px;
  border-bottom-left-radius: 999px;
}

.booked.end {
  border-top-right-radius: 999px;
  border-bottom-right-radius: 999px;
}

.booked.single {
  border-radius: 999px;
}

/* è®©è¿ç»­ booking è¿æˆä¸€æ¡ */
.booked:not(.start) {
  border-left-color: transparent;
}

.booked:not(.end) {
  border-right-color: transparent;
}

/* ===== SELECTEDï¼ˆæ–°å»º booking æ—¶ï¼‰ ===== */
.selected {
  outline: 2px solid var(--accent);
  outline-offset: -2px;
  border-radius: 6px;
}

/* ===== DESKTOP HOVERï¼ˆå®‰å…¨ï¼‰ ===== */
@media (hover: hover) {
  .cell.free:hover {
    background: #fff2d6;
  }
}

/* ===== MODAL ===== */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.35);
  z-index: 100;
}

.modal-box {
  background: #ffffff;
  margin: 22% auto;
  padding: 14px;
  width: 90%;
  max-width: 320px;
  border-radius: 16px;
}

.modal-box h3 {
  margin: 0 0 10px;
  font-size: 16px;
  font-weight: 600;
}

.modal-box label {
  font-size: 12px;
  color: var(--muted);
}

.modal-box input,
.modal-box select {
  width: 100%;
  height: 32px;
  margin-bottom: 8px;
  font-size: 14px;
}

.modal-box button {
  width: 100%;
  height: 36px;
  margin-top: 6px;
  border-radius: 10px;
  border: none;
  font-size: 14px;
}

.primary {
  background: var(--accent);
  color: #ffffff;
}

.secondary {
  background: #e5e5ea;
}

.danger {
  background: #ff3b30;
  color: #ffffff;
}

/* ===== FIX: HEADER å·¦ä¸Šè§’ä¸è¦ sticky ===== */

/* Header é‡Œçš„ room-col å–æ¶ˆ sticky */
.header .room-col {
  position: relative !important;
  left: auto !important;
  z-index: 1 !important;
  background: #ffffff;
}

/* çœŸæ­£çš„ Room åˆ—ï¼ˆrow é‡Œçš„ï¼‰ä¿æŒ sticky */
.row .room-col {
  position: sticky;
  left: 0;
  z-index: 30;
}

/* Header æœ¬èº«åªè´Ÿè´£æ¨ªå‘ï¼Œä¸å’Œ row æŠ¢çºµå‘ */
.header {
  position: sticky;
  top: 42px;   /* å¯¹é½ topbar */
  z-index: 10;
  height: var(--row-h);
}

</style>
</head>

<body>

<div class="topbar">
  <input id="monthPicker" type="month">
</div>

<div class="wrapper" id="app"></div>

<!-- MODAL -->
<div id="bookingModal" class="modal">
  <div class="modal-box">
    <h3 id="modalTitle">Booking</h3>

    <label>Room</label>
    <select id="roomSelect"></select>

    <label>Check-in</label>
    <input id="checkInInput" readonly>

    <label>Check-out</label>
    <input id="checkOutInput" readonly>

    <button id="actionBtn" class="primary">Save</button>
    <button id="deleteBtn" class="danger">Delete</button>
    <button class="secondary" onclick="closeModal()">Close</button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

const API_URL = 'https://script.google.com/macros/s/AKfycbxdl0gBcDgUcH8wtw1DUEb9RLHh3RHgXs9u3Gp6r-7V-pnrtFZXht7V9GydnQO8I0ja/exec';

/* ===== STATE ===== */
let ROOMS = [];
let BOOKINGS = [];
let BOOKED_MAP = {};
let DAYS = [];
let CURRENT_MONTH = '';
let SELECTED_ROOM = null;
let SELECTED_START = null;
let CURRENT_EDIT = null;

/* ===== ELEMENTS ===== */
const app = document.getElementById('app');
const monthPicker = document.getElementById('monthPicker');

/* ===== INIT ===== */
CURRENT_MONTH = new Date().toISOString().slice(0,7);
monthPicker.value = CURRENT_MONTH;

loadData(true);

/* ===== LEVEL 2: AUTO REFRESH ===== */
setInterval(() => silentRefresh(), 5000);

/* ===== EVENTS ===== */
monthPicker.addEventListener('change', e => {
  CURRENT_MONTH = e.target.value;
  DAYS = buildMonthDays(CURRENT_MONTH);
  updateMonthView();
  clearSelection();
});

/* ===== DATA ===== */
function loadData(initial=false) {
  fetch(API_URL, { cache:'no-store' })
    .then(r => r.json())
    .then(data => {
      ROOMS = data.rooms;
      BOOKINGS = data.bookings;
      BOOKED_MAP = buildBookedMap(BOOKINGS);
      DAYS = buildMonthDays(CURRENT_MONTH);
      if (initial) renderGrid();
      else updateCells();
    });
}

function silentRefresh() {
  fetch(API_URL, { cache:'no-store' })
    .then(r => r.json())
    .then(data => {
      const newMap = buildBookedMap(data.bookings);
      if (!sameMap(newMap, BOOKED_MAP)) {
        BOOKINGS = data.bookings;
        BOOKED_MAP = newMap;
        updateCells();
      }
    });
}

function sameMap(a,b) {
  const ka = Object.keys(a);
  const kb = Object.keys(b);
  if (ka.length !== kb.length) return false;
  return ka.every(k => b[k]);
}

function buildMonthDays(month) {
  const [y,m] = month.split('-').map(Number);
  const total = new Date(y,m,0).getDate();
  return Array.from({length:total},(_,i)=>
    `${y}-${String(m).padStart(2,'0')}-${String(i+1).padStart(2,'0')}`
  );
}

function buildBookedMap(bookings) {
  const map = {};
  bookings.forEach(b => {
    let d = new Date(b.checkIn);
    const end = new Date(b.checkOut);
    while (d < end) {
      map[`${b.room}|${d.toISOString().slice(0,10)}`] = b;
      d.setDate(d.getDate()+1);
    }
  });
  return map;
}

/* ===== RENDER ===== */
function renderGrid() {
  app.innerHTML = '';
  const header = document.createElement('div');
  header.className = 'header';
  header.appendChild(document.createElement('div')).className = 'room-col';
  app.appendChild(header);

  ROOMS.forEach(room => {
    const row = document.createElement('div');
    row.className = 'row';

    const label = document.createElement('div');
    label.className = 'room-col';
    label.textContent = room;
    row.appendChild(label);

    DAYS.forEach(day => {
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.dataset.room = room;
      cell.dataset.date = day;
      row.appendChild(cell);
    });
    app.appendChild(row);
  });

  updateMonthView();
}

function updateMonthView() {
  updateHeader();
  updateCells();
}

function updateHeader() {
  const header = document.querySelector('.header');
  header.innerHTML = '';
  header.appendChild(document.createElement('div')).className = 'room-col';
  DAYS.forEach(d => {
    const c = document.createElement('div');
    c.className = 'cell';
    c.textContent = d.slice(8);
    header.appendChild(c);
  });
}

function updateCells() {
  document.querySelectorAll('.row').forEach(row => {
    const room = row.querySelector('.room-col').textContent;
    const cells = row.querySelectorAll('.cell');

    cells.forEach((cell, idx) => {
      if (idx === 0) return;

      const day = DAYS[idx - 1];
      cell.dataset.date = day;

      const key = `${room}|${day}`;
      cell.className = 'cell';

      if (BOOKED_MAP[key]) {
        cell.classList.add('booked');

        const prevDay = DAYS[idx - 2];
        const nextDay = DAYS[idx];

        const hasPrev = prevDay && BOOKED_MAP[`${room}|${prevDay}`];
        const hasNext = nextDay && BOOKED_MAP[`${room}|${nextDay}`];

        if (!hasPrev && !hasNext) {
          cell.classList.add('single');
        } else if (!hasPrev && hasNext) {
          cell.classList.add('start');
        } else if (hasPrev && !hasNext) {
          cell.classList.add('end');
        }
        // ä¸­é—´æ®µä¸éœ€è¦é¢å¤– class
      } else {
        cell.classList.add('free');
      }
    });
  });
}

/* ===== CLICK ===== */
app.addEventListener('click', e => {
  const cell = e.target;
  if (!cell.classList.contains('cell')) return;
  if (!cell.dataset.room || !cell.dataset.date) return;

  const room = cell.dataset.room;
  const day = cell.dataset.date;
  const booking = BOOKED_MAP[`${room}|${day}`];

  if (booking) openEditModal(booking);
  else handleNewClick(room, day);
});

/* ===== NEW ===== */
function handleNewClick(room, day) {
  clearSelection();
  if (!SELECTED_START || SELECTED_ROOM !== room) {
    SELECTED_ROOM = room;
    SELECTED_START = day;
    highlight(room,day,day);
    return;
  }
  if (day > SELECTED_START) {
    openNewModal(room, SELECTED_START, day);
    SELECTED_ROOM = SELECTED_START = null;
    clearSelection();
  } else {
    SELECTED_START = day;
    highlight(room,day,day);
  }
}

/* ===== MODAL ===== */
function populateRooms(selected) {
  roomSelect.innerHTML = '';
  ROOMS.forEach(r=>{
    const o=document.createElement('option');
    o.value=r; o.textContent=r;
    if(r===selected) o.selected=true;
    roomSelect.appendChild(o);
  });
}

function openNewModal(room, ci, co) {
  CURRENT_EDIT = null;
  modalTitle.textContent = 'New Booking';
  actionBtn.textContent = 'Save';
  deleteBtn.style.display = 'none';
  populateRooms(room);
  checkInInput.value = ci;
  checkOutInput.value = co;
  bookingModal.style.display = 'block';
}

function openEditModal(b) {
  CURRENT_EDIT = b;
  modalTitle.textContent = 'Edit Booking';
  actionBtn.textContent = 'Update';
  deleteBtn.style.display = 'block';
  populateRooms(b.room);
  checkInInput.value = b.checkIn;
  checkOutInput.value = b.checkOut;
  bookingModal.style.display = 'block';
}

window.closeModal = ()=> bookingModal.style.display='none';

/* ===== SAVE / UPDATE / DELETE ===== */
actionBtn.onclick = () => {
  const payload = {
    action: CURRENT_EDIT ? 'update' : 'create',
    old: CURRENT_EDIT,
    room: roomSelect.value,
    checkIn: checkInInput.value,
    checkOut: checkOutInput.value
  };

  fetch(API_URL,{method:'POST',body:JSON.stringify(payload)})
    .then(r=>r.json())
    .then(res=>{
      if(res.status==='conflict'){
        alert('Room status updated. Please try again.');
        return;
      }
      loadData(); // å±€éƒ¨æ›´æ–°ï¼Œä¸ç™½å±
      closeModal();
    });
};

deleteBtn.onclick = () => {
  fetch(API_URL,{
    method:'POST',
    body:JSON.stringify({action:'delete', booking: CURRENT_EDIT})
  }).then(()=>{ loadData(); closeModal(); });
};

/* ===== UI HELPERS ===== */
function highlight(room,start,end){
  document.querySelectorAll('.cell').forEach(c=>c.classList.remove('selected'));
  document.querySelectorAll(`.cell[data-room="${room}"]`)
    .forEach(c=>{
      if(c.dataset.date>=start && c.dataset.date<=end)
        c.classList.add('selected');
    });
}
function clearSelection(){
  document.querySelectorAll('.cell').forEach(c=>c.classList.remove('selected'));
}

});
</script>

</body>
</html>
