<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Booking Calendar</title>

<style>
:root {
  --row-h: 32px;
  --cell-w: 56px;
  --room-w: 90px;
  --border: #ddd;
  --free: #FFF8EB;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont,
    "SF Pro Text","Helvetica Neue",Arial,sans-serif;
  background: #fff;
}

/* ===== Top ===== */
.topbar {
  padding: 8px 10px;
  border-bottom: 1px solid var(--border);
}

/* ===== Calendar ===== */
.wrapper {
  overflow-x: auto;
}

.header,
.row {
  display: grid;
  grid-auto-flow: column;
  grid-auto-columns: min-content;
}

.room-col {
  width: var(--room-w);
  min-width: var(--room-w);
  height: var(--row-h);
  line-height: var(--row-h);
  text-align: center;
  background: #fafafa;
  border-right: 1px solid var(--border);
  font-size: 13px;
}

/* Desktop sticky room */
@media (min-width: 769px) {
  .room-col {
    position: sticky;
    left: 0;
    z-index: 5;
  }
}

.cell {
  width: var(--cell-w);
  height: var(--row-h);
  border: 1px solid var(--border);
  text-align: center;
  font-size: 12px;
  cursor: pointer;
  user-select: none;
}

.free { background: var(--free); }
.booked { color: #fff; }

/* Prevent room highlight */
.room-col:hover,
.row:hover .room-col {
  background: #fafafa !important;
}

/* ===== Source colors ===== */
.src-booking { background:#003580; }
.src-trip { background:#ff6f00; }
.src-agoda { background:#e60023; }
.src-airbnb { background:#ff385c; }
.src-slh { background:#6a5acd; }
.src-walkinwayne { background:#2e8b57; }
.src-walkinsoo { background:#4682b4; }

/* ===== Modal ===== */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.35);
  z-index: 9999;
}

.modal-box {
  background: #fff;
  width: 90%;
  max-width: 320px;
  margin: 20% auto;
  padding: 14px;
  border-radius: 12px;
}

.modal-box h3 {
  margin: 0 0 10px;
}

.modal-box input,
.modal-box button {
  width: 100%;
  height: 34px;
  margin-bottom: 8px;
}

/* ===== Source buttons ===== */
.source-group {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 10px;
}

.source-btn {
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 12px;
  border: 1px solid #ccc;
  background: #fff;
  cursor: pointer;
}

.source-btn.active {
  border-color: transparent;
  color: #fff;
}
</style>
</head>

<body>

<div class="topbar">
  <input type="month" id="monthPicker">
</div>

<div class="wrapper" id="app"></div>

<!-- ===== Modal ===== -->
<div class="modal" id="modal">
  <div class="modal-box">
    <h3 id="modalTitle">Booking</h3>

    <label>Room</label>
    <div id="roomDisplay" style="margin-bottom:8px;font-weight:600;"></div>

    <label>Source</label>
    <div id="sourceGroup" class="source-group"></div>

    <label>Check-in</label>
    <input id="checkInInput" readonly>

    <label>Check-out</label>
    <input id="checkOutInput" readonly>

    <button id="saveBtn">Save</button>
    <button id="deleteBtn">Delete</button>
    <button onclick="closeModal()">Close</button>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const API_URL = 'PASTE_YOUR_APPS_SCRIPT_URL_HERE';

const SOURCES = [
  "Booking",
  "Trip",
  "Agoda",
  "Airbnb",
  "SLH",
  "Walk-in (Wayne)",
  "Walk-in (Soo)"
];

/* ===== STATE ===== */
let ROOMS=[], BOOKINGS=[], BOOKED_MAP={}, DAYS=[];
let CURRENT_ROOM=null, CURRENT_SOURCE=null, EDIT_BOOKING=null;

/* ===== INIT ===== */
const app = document.getElementById('app');
const monthPicker = document.getElementById('monthPicker');
monthPicker.value = new Date().toISOString().slice(0,7);
monthPicker.onchange = load;

load();

/* ===== LOAD ===== */
function load(){
  fetch(API_URL).then(r=>r.json()).then(data=>{
    ROOMS=data.rooms;
    BOOKINGS=data.bookings;
    BOOKED_MAP=buildMap(BOOKINGS);
    DAYS=buildDays(monthPicker.value);
    render();
  });
}

function buildDays(m){
  const [y,mo]=m.split('-').map(Number);
  return Array.from({length:new Date(y,mo,0).getDate()},(_,i)=>
    `${y}-${String(mo).padStart(2,'0')}-${String(i+1).padStart(2,'0')}`
  );
}

function buildMap(bks){
  const map={};
  bks.forEach(b=>{
    let d=new Date(b.checkIn),e=new Date(b.checkOut);
    while(d<e){
      map[`${b.room}|${d.toISOString().slice(0,10)}`]=b;
      d.setDate(d.getDate()+1);
    }
  });
  return map;
}

/* ===== RENDER ===== */
function render(){
  app.innerHTML='';
  const header=document.createElement('div');
  header.className='header';
  header.appendChild(document.createElement('div')).className='room-col';
  DAYS.forEach(d=>{
    const c=document.createElement('div');
    c.className='cell';
    c.textContent=d.slice(8);
    header.appendChild(c);
  });
  app.appendChild(header);

  ROOMS.forEach(room=>{
    const row=document.createElement('div');
    row.className='row';
    const r=document.createElement('div');
    r.className='room-col';
    r.textContent=room;
    row.appendChild(r);

    DAYS.forEach(day=>{
      const key=`${room}|${day}`;
      const c=document.createElement('div');
      if(BOOKED_MAP[key]){
        const s=BOOKED_MAP[key].source.toLowerCase().replace(/[^a-z]/g,'');
        c.className=`cell booked src-${s}`;
      }else{
        c.className='cell free';
      }
      c.onclick=()=>cellClick(room,day);
      row.appendChild(c);
    });
    app.appendChild(row);
  });
}

/* ===== INTERACTION ===== */
function cellClick(room,day){
  const b=BOOKED_MAP[`${room}|${day}`];
  if(b){ openEdit(b); return; }
  CURRENT_ROOM=room;
  document.getElementById('roomDisplay').textContent=room;
  renderSources(SOURCES[0]);
  document.getElementById('checkInInput').value=day;
  document.getElementById('checkOutInput').value=day;
  EDIT_BOOKING=null;
  document.getElementById('modal').style.display='block';
}

/* ===== SOURCE ===== */
function renderSources(selected){
  const g=document.getElementById('sourceGroup');
  g.innerHTML='';
  SOURCES.forEach(s=>{
    const b=document.createElement('div');
    b.className=`source-btn src-${s.toLowerCase().replace(/[^a-z]/g,'')}`;
    b.textContent=s;
    if(s===selected){ b.classList.add('active'); CURRENT_SOURCE=s; }
    b.onclick=()=>{
      CURRENT_SOURCE=s;
      g.querySelectorAll('.source-btn').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
    };
    g.appendChild(b);
  });
}

/* ===== MODAL ===== */
function openEdit(b){
  EDIT_BOOKING=b;
  CURRENT_ROOM=b.room;
  document.getElementById('roomDisplay').textContent=b.room;
  renderSources(b.source);
  checkInInput.value=b.checkIn;
  checkOutInput.value=b.checkOut;
  deleteBtn.style.display='block';
  modal.style.display='block';
}

function closeModal(){
  modal.style.display='none';
}

/* ===== SAVE / DELETE ===== */
saveBtn.onclick=()=>{
  fetch(API_URL,{
    method:'POST',
    body:JSON.stringify({
      action:EDIT_BOOKING?'update':'create',
      old:EDIT_BOOKING,
      room:CURRENT_ROOM,
      checkIn:checkInInput.value,
      checkOut:checkOutInput.value,
      source:CURRENT_SOURCE
    })
  }).then(load);
};

deleteBtn.onclick=()=>{
  fetch(API_URL,{
    method:'POST',
    body:JSON.stringify({action:'delete',booking:EDIT_BOOKING})
  }).then(load);
};
</script>

</body>
</html>
