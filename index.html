<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Booking Calendar</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
/* ===== GLOBAL ===== */
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family:
    -apple-system,
    BlinkMacSystemFont,
    "SF Pro Text",
    "SF Pro Display",
    system-ui,
    Arial;
  background: #fff;
  color: #111;
}

/* ===== TOP BAR ===== */
.topbar {
  padding: 10px 12px;
  border-bottom: 1px solid #e5e5e5;
}

/* ===== CALENDAR ===== */
.wrapper { overflow-x: auto; }
.header, .row {
  display: grid;
  grid-auto-flow: column;
  grid-auto-columns: 56px;
}

/* Sticky Y axis */
.room {
  width: 120px;               /* üëà Ë∞ÉÁ™Ñ */
  padding: 6px 8px;
  font-size: 13px;
  background: #fafafa;
  border-right: 1px solid #e5e5e5;
  white-space: nowrap;
  position: sticky;
  left: 0;
  z-index: 3;
}
.header .room {
  background: #f5f5f5;
  z-index: 4;
}

.cell {
  height: 32px;
  line-height: 32px;
  text-align: center;
  font-size: 12px;
  border: 1px solid #eee;
}

.free {
  background: #fff8eb;
  cursor: pointer;
}
.booked {
  color: #fff;
  cursor: pointer;
}

/* üëâ Á¨¨‰∏ÄÊ¨°ÁÇπÁöÑÊ∑°Á∫¢ÊèêÁ§∫ */
.selecting {
  background: rgba(255, 56, 92, 0.25);
}

/* booking colors */
.src-airbnb { background:#ff385c; }
.src-booking { background:#003580; }
.src-agoda { background:#e60023; }
.src-trip { background:#ff6f00; }
.src-slh { background:#6a5acd; }
.src-walkinwayne { background:#2e8b57; }
.src-walkinsoo { background:#8b4513; }

/* ===== MODAL (iOS) ===== */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.35);
  display: none;
  z-index: 999;
}
.modal-box {
  background: #fff;
  border-radius: 16px 16px 0 0;
  padding: 16px;
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
}
.modal-box label {
  font-size: 12px;
  color: #555;
}
.modal-box input,
.modal-box select,
.modal-box button {
  width: 100%;
  padding: 10px;
  margin: 6px 0;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #ddd;
}
.actions {
  display: flex;
  gap: 8px;
}
.actions button { flex: 1; }
</style>
</head>

<body>

<div class="topbar">
  <input type="month" id="monthPicker">
</div>

<div class="wrapper" id="app"></div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="modal-box">
    <h3 id="modalTitle">Booking</h3>

    <label>Room</label>
    <input id="roomInput">

    <label>Check-in</label>
    <input type="date" id="checkInInput">

    <label>Check-out</label>
    <input type="date" id="checkOutInput">

    <label>Source</label>
    <select id="sourceInput">
      <option>Airbnb</option>
      <option>Booking</option>
      <option>Agoda</option>
      <option>Trip</option>
      <option>SLH</option>
      <option>Walk-in (Wayne)</option>
      <option>Walk-in (Soo)</option>
    </select>

    <div class="actions">
      <button id="saveBtn">Save</button>
      <button id="deleteBtn" style="display:none">Delete</button>
      <button onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const SUPABASE_URL = 'https://pwscsukxfnbzjciuhtwl.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3c2NzdWt4Zm5iempjaXVodHdsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MzU1MDQsImV4cCI6MjA4MjExMTUwNH0.YQEXs1S3wprPMOarCL_DLXDtsSgY6I7TFM4bp_gLkW8';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== STATE ===== */
let ROOMS=[], BOOKINGS=[], DAYS=[];
let SELECT_STEP = 0;
let START_DAY = null;
let START_ROOM = null;
let START_CELL = null;
let EDITING = null;

/* ===== DOM ===== */
const app = document.getElementById('app');
const monthPicker = document.getElementById('monthPicker');
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const roomInput = document.getElementById('roomInput');
const checkInInput = document.getElementById('checkInInput');
const checkOutInput = document.getElementById('checkOutInput');
const sourceInput = document.getElementById('sourceInput');
const saveBtn = document.getElementById('saveBtn');
const deleteBtn = document.getElementById('deleteBtn');

/* ===== BOOT ===== */
monthPicker.value = new Date().toISOString().slice(0,7);
monthPicker.onchange = loadAll;
loadAll();
setupRealtime();

/* ===== LOAD ===== */
async function loadAll() {
  ROOMS = (await sb.from('rooms').select('*').order('id')).data || [];
  BOOKINGS = (await sb.from('booking_view').select('*')).data || [];
  buildDays();
  render();
}

function buildDays() {
  const [y,m] = monthPicker.value.split('-').map(Number);
  DAYS = [...Array(new Date(y,m,0).getDate())]
    .map((_,i)=>`${y}-${String(m).padStart(2,'0')}-${String(i+1).padStart(2,'0')}`);
}

function isBooked(room, day) {
  return BOOKINGS.some(b => b.room === room && day >= b.check_in && day < b.check_out);
}

/* ===== CLICK LOGIC ===== */
function clickFree(room, day, cell) {
  if (isBooked(room, day)) return;

  // Á¨¨‰∫åÊ¨°‰ΩÜÁÇπ‰∫ÜÂà´ÁöÑ room ‚Üí reset ÊàêÁ¨¨‰∏ÄÊ¨°
  if (SELECT_STEP === 1 && room !== START_ROOM) {
    clearSelecting();
    SELECT_STEP = 0;
  }

  if (SELECT_STEP === 0) {
    START_DAY = day;
    START_ROOM = room;
    START_CELL = cell;
    SELECT_STEP = 1;
    cell.classList.add('selecting');
  } else {
    clearSelecting();
    SELECT_STEP = 0;
    openNew(room, START_DAY, day);
  }
}

function clearSelecting() {
  document.querySelectorAll('.selecting')
    .forEach(c => c.classList.remove('selecting'));
}

/* ===== RENDER ===== */
function render() {
  app.innerHTML = '';

  const header = document.createElement('div');
  header.className = 'header';
  header.appendChild(Object.assign(document.createElement('div'), { className:'room' }));
  DAYS.forEach(d=>{
    const c=document.createElement('div');
    c.className='cell';
    c.textContent=d.slice(8);
    header.appendChild(c);
  });
  app.appendChild(header);

  ROOMS.forEach(r=>{
    const row=document.createElement('div');
    row.className='row';

    const rc=document.createElement('div');
    rc.className='room';
    rc.textContent=r.name;
    row.appendChild(rc);

    DAYS.forEach(d=>{
      const cell=document.createElement('div');
      const b=BOOKINGS.find(x=>x.room===r.name && d>=x.check_in && d<x.check_out);
      if (b){
        cell.className=`cell booked src-${b.source.toLowerCase().replace(/[^a-z]/g,'')}`;
        cell.onclick=()=>openEdit(b);
      } else {
        cell.className='cell free';
        cell.onclick=()=>clickFree(r.name, d, cell);
      }
      row.appendChild(cell);
    });
    app.appendChild(row);
  });
}

/* ===== MODAL ===== */
function openNew(room, start, end) {
  EDITING = null;
  modalTitle.textContent = 'New Booking';

  roomInput.value = room;
  roomInput.disabled = true;

  checkInInput.value = start;
  checkInInput.disabled = true;

  const d = new Date(start);
  d.setDate(d.getDate() + 1);
  checkOutInput.value = d.toISOString().slice(0,10);
  checkOutInput.disabled = false;

  saveBtn.textContent = 'Save';
  deleteBtn.style.display = 'none';
  modal.style.display = 'block';
}

function openEdit(b) {
  EDITING = b;
  modalTitle.textContent = 'Edit Booking';

  roomInput.value = b.room;
  roomInput.disabled = false;
  checkInInput.value = b.check_in;
  checkInInput.disabled = false;
  checkOutInput.value = b.check_out;
  checkOutInput.disabled = false;
  sourceInput.value = b.source;

  saveBtn.textContent = 'Update';
  deleteBtn.style.display = 'block';
  modal.style.display = 'block';
}

function closeModal() {
  modal.style.display = 'none';
  clearSelecting();
  SELECT_STEP = 0;
}

/* ===== SAVE / DELETE ===== */
saveBtn.onclick = async () => {
  if (new Date(checkOutInput.value) <= new Date(checkInInput.value)) {
    alert('Checkout must be at least 1 day after check-in');
    return;
  }

  const room = ROOMS.find(r=>r.name===roomInput.value);
  const payload = {
    room_id: room.id,
    check_in: checkInInput.value,
    check_out: checkOutInput.value,
    source: sourceInput.value
  };

  let res;
  if (EDITING) {
    res = await sb.from('bookings').update(payload).eq('id', EDITING.id);
  } else {
    res = await sb.from('bookings').insert(payload);
  }
  if (res.error) { alert(res.error.message); return; }
  closeModal();
};

deleteBtn.onclick = async () => {
  if (!EDITING) return;
  if (!confirm('Delete booking?')) return;
  await sb.from('bookings').delete().eq('id', EDITING.id);
  closeModal();
};

/* ===== REALTIME ===== */
function setupRealtime() {
  sb.channel('rt-bookings')
    .on('postgres_changes', { event:'*', schema:'public', table:'bookings' }, loadAll)
    .subscribe();
}
</script>
</body>
</html>
